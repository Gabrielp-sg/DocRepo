---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chatbot-atendimento
  namespace: chatbot
  labels:
    app: chatbot-atendimento
spec:
  selector:
    matchLabels:
      app: chatbot-atendimento
  template:
    metadata:
      labels:
        app: chatbot-atendimento
    spec:
      containers:
        - env:
            - name: APPLICATION_PORT
              value: "8080"
            - name: DB2_USERNAME
              valueFrom:
                secretKeyRef:
                  key: db2-chatbot-username
                  name: db2-chatbot
            - name: DB2_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: db2-chatbot-password
                  name: db2-chatbot
            - name: DB2_LIBRARY
              valueFrom:
                secretKeyRef:
                  key: db2-chatbot-library
                  name: db2-chatbot
            - name: POSTGRES_SERVICES_URL
              valueFrom:
                secretKeyRef:
                  key: postgres-services-url
                  name: postgres-services
            - name: POSTGRES_SERVICES_PORT
              valueFrom:
                secretKeyRef:
                  key: postgres-services-port
                  name: postgres-services
            - name: POSTGRES_SERVICES_DATABASE
              valueFrom:
                secretKeyRef:
                  key: postgres-services-database
                  name: postgres-services
            - name: POSTGRES_SERVICES_USERNAME
              valueFrom:
                secretKeyRef:
                  key: postgres-services-username
                  name: postgres-services
            - name: POSTGRES_SERVICES_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: postgres-services-password
                  name: postgres-services
            - name: SYDLEONE_URL
              valueFrom:
                secretKeyRef:
                  key: sydleone-chatbot-url
                  name: sydleone-chatbot
            - name: SYDLEONE_TOKEN
              valueFrom:
                secretKeyRef:
                  key: sydleone-chatbot-token
                  name: sydleone-chatbot
            - name: CHATBOT_URL
              valueFrom:
                secretKeyRef:
                  key: blip-chatbot-url
                  name: blip-chatbot
            - name: CHATBOT_USERNAME
              valueFrom:
                secretKeyRef:
                  key: blip-chatbot-username
                  name: blip-chatbot
            - name: CHATBOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: blip-chatbot-password
                  name: blip-chatbot
            - name: CHATBOT_KEY
              valueFrom:
                secretKeyRef:
                  key: blip-chatbot-key
                  name: blip-chatbot
            - name: SUPPLIER_URL
              valueFrom:
                secretKeyRef:
                  key: supplier-chatbot-url
                  name: supplier-chatbot
            - name: RMT_API_URL
              valueFrom:
                secretKeyRef:
                  key: rmt-ticketlog-api-url
                  name: rmt-ticketlog-api
            - name: RMT_API_USER
              valueFrom:
                secretKeyRef:
                  key: rmt-ticketlog-api-username
                  name: rmt-ticketlog-api
            - name: RMT_API_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: rmt-ticketlog-api-password
                  name: rmt-ticketlog-api
            - name: ERROR_URI
              value: "http://error-message.error:8080/error/v1/code/"
            - name: ISSUER_URI
              value: "http://auth-token.auth:8080/"
            - name: EVENT_URI
              value: "http://event-log-event.event-log:8080/service/event/v1/log/criar"
          name: chatbot-atendimento
          image: 'cr.core-services.leaseplan.systems/0072/chatbot-atendimento:DEV-2.0.x8'
          ports:
          - containerPort: 8080
          resources:
            limits:
              memory: "400Mi"
              cpu: "100m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
      imagePullSecrets:
        - name: harbor-docker-creds

---
apiVersion: v1
kind: Service
metadata:
  name: chatbot-atendimento
  namespace: chatbot
spec:
  type: NodePort
  ports:
    - name: http
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app: chatbot-atendimento

      



include:
  - project: 'templates/gitlab-ci/pipelines'
    ref: master
    file: 'kaniko/login.yml'

workflow:
  rules:
    - when: always

stages:
  - build
  - development
  - uat
  - production

variables:
  LZ_KANIKO_EXECUTOR_IMAGE: cr.core-services.leaseplan.systems/lz/lz-kaniko:master
  LZ_DOCKER_REGISTRY: https://cr.core-services.leaseplan.systems
  VAULT_AUTH_ROLE: workloads-0072-wkl-lpbr-apps
  ARTIFACTORY_ROLE_DOCKER: art-0072-write-docker-local-default
  KANIKO_EXTRA_ARGS: ""
  KANIKO_EXTRA_ARGS_BUILD: ""
  DOCKER_FILE: chatbot-agendamento/Dockerfile
  DOCKER_REGISTRY: cr.core-services.leaseplan.systems/0072
  DOCKER_IMAGE_NAME: chatbot-agendamento
  VERSION: 1.1.2
  container: docker
  KUBERNETES_MEMORY_REQUEST: 1Gi
  KUBERNETES_MEMORY_LIMIT: 12Gi

build:
  tags:
    - k8s-scalable
  stage: build
  image:  $LZ_KANIKO_EXECUTOR_IMAGE
  extends:
    - .kaniko-login
  script:
    - |
      /kaniko/executor \
        --context $CI_PROJECT_DIR \
        --dockerfile $CI_PROJECT_DIR/$DOCKER_FILE \
        --no-push

development:
  tags:
    - k8s-scalable
  stage: development
  dependencies:
    - build
  image:  $LZ_KANIKO_EXECUTOR_IMAGE
  extends:
    - .kaniko-login
  before_script:
    - apk add --no-cache git
    - git clone git@gitlab.core-services.leaseplan.systems:workloads/0072-wkl-lpbr-apps/mobile-app.git
    - git checkout develop  
  script:
    - echo "Deploying to development environment"
    - |
      /kaniko/executor \
        --context $CI_PROJECT_DIR \
        --dockerfile $CI_PROJECT_DIR/$DOCKER_FILE \
        --destination $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:DEV-$VERSION
  when: manual
  environment:
    name: development
  only:
    - develop

uat:
  tags:
    - k8s-scalable
  stage: uat
  dependencies:
    - build
  image:  $LZ_KANIKO_EXECUTOR_IMAGE
  extends:
    - .kaniko-login
  script:
    - echo "Deploying to uat environment"
    - |
      /kaniko/executor \
        --context $CI_PROJECT_DIR \
        --dockerfile $CI_PROJECT_DIR/$DOCKER_FILE \
        --destination $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:RELEASE-$VERSION
  when: manual
  environment:
    name: uat
  only:
    - release

production:
  tags:
    - k8s-scalable
  stage: production
  dependencies:
    - build
  image:  $LZ_KANIKO_EXECUTOR_IMAGE
  extends:
    - .kaniko-login
  script:
    - echo "Deploying to production environment"
    - |
      /kaniko/executor \
        --context $CI_PROJECT_DIR \
        --dockerfile $CI_PROJECT_DIR/$DOCKER_FILE \
        --destination $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:$VERSION
  when: manual
  environment:
    name: production
  only:
    - master

