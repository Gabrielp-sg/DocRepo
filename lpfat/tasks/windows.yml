---
# here some exampels on how to join the domain by using a role and how to setup rdp access.
- name: join the domain
  include_role:
    name: 'domain_join'

- name: set remote desktop users
  ansible.windows.win_group_membership:
    name: remote desktop users
    members: "{{ remote_desktop_users }}"
    state: present

- name: set local admins
  ansible.windows.win_group_membership:
    name: administrators
    members: "{{ local_administrators }}"
    state: present

- name: Get credencials SMB AWS Secrets Manager
  ansible.windows.win_shell: |
    $secretJson = aws secretsmanager get-secret-value `
      --region {{ aws_region }} `
      --secret-id {{ secret_smb }} `
      --query SecretString `
      --output text
    $secret = $secretJson | ConvertFrom-Json
    @{
      username = $secret.username
      password = $secret.password
    } | ConvertTo-Json
  register: smb_credentials_raw
  no_log: true

- name: Parse credencials SMB
  set_fact:
    smb_credentials: "{{ smb_credentials_raw.stdout | from_json }}"
  no_log: true

- name: Create Windows user for SMB authentication
  ansible.windows.win_user:
    name: "{{ smb_credentials.username }}"
    password: "{{ smb_credentials.password }}"
    password_never_expires: yes
    state: present
    groups:
      - Users

- name: Set permissions on directories
  ansible.windows.win_acl:
    path: C:\STCPCLT_BRADESCO\O0055BRADESCO\{{ item }}
    user: "{{ smb_credentials.username }}"
    rights: FullControl
    type: allow
    state: present
  loop: [ "ENTRADA", "SAIDA" ]

- name: Create SMB shares
  ansible.windows.win_share:
    path: C:\STCPCLT_BRADESCO\O0055BRADESCO\{{ item }}
    name: "{{ item }}"
    read: "{{ smb_credentials.username }}"
    change: "{{ smb_credentials.username }}"
  loop: [ "ENTRADA", "SAIDA" ]

- name: Configurar permissões SMB específicas
  ansible.windows.win_shell: |
    Grant-SmbShareAccess -Name "{{ item }}" -AccountName "{{ smb_credentials.username }}" -AccessRight Full -Force
  loop: [ "ENTRADA", "SAIDA" ]





# - name: Download the Scopus tool installer
